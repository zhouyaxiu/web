<style lang='less'>
  .isactive {
    background: #15b3e4
  }

  .noactive {
      background: #dedede
  }

  .weui-cell_ft {
      position: absolute;
      right: 20rpx;
  }

  .login {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAFmklEQVR4XuVb/5EVNwy2KwhUEKiAUAFoGwAqCFQQqACoIEcFOSrgaGB1VMClglwqyFGBmY/Ru9nnk23J9ntH5jxzwx/rt2t9+vTDkojhjq94x+UPRwWAmX8LITwJIdwLITzNwL8IIVyllM6XZflyLMUcHABmhqC/hxCei+BW2c5SSqfLsny2/qBn38EAEMHfKpr2nvMyhPCOiD56f2jZPx0AZga9/xKNW85g3QMTeUVE+HfamgqAaP2TheoppT07jzHCN1gWQDi1bLTsmQYAM78UzavfhcAxxrMQwhkRgdY3lrAHvgJ/zyoCnBLRK4uArT1TAKgJL4K/9lKXmR/A9sWBanJMAWEYAKE95ydMKX2LMT4novOWFmrPEToRDWKMj5R9b4joZOT9QwAIZf/JbT6l9HeM8aVX6yVB8J2U0lnBTzwe+c4oAHB4sNfrJcI/JaKrEc0UfAR8SO4bLonoYe+3ugHQqC+0h/BTQ9VOOGHCuWIO74kI/sK9RgCA3efpLI3afEsCOMeU0kWM8ZfNXrDtYQ/rugAoaP/Lsiw5IC15up4zM7SNLHO7uhxiLwBIRJDfb9eQM/IgIaZwmbHggogee96Dvb0A/Lf1/Ij1x9L+xh8g/P2RCQwzUJOsEjBuAORK+3UG/bza2u4v5B/uNLkHgNchhD9HkR8RfvfbdV2vMjP4QEQ4n3n1AHDDARGR+z3mE1Y2ruuKkHh9ieoxRffBZ3x0hvB4BzPvJUZ3EYBhNv7fGXB8AGbQbqIJ7OUjuIcsy4LCq3m5GaBkYVdEdN/8xYkbZ/ijHgC0MHi/Jw8fxYKZcRVH4WS3PhIRKlPm1QMA8v28AOJOQMwnLGyclZC5AZDwk7JzfSaivbrAqICt3zOzlgq77yO9AGiFCXce3hKy9FwqUUjHr+mfUvp3WZatOZhe3wsAtI1q0Ha57c90QmVT4TrsToPx6i4A8MN1XXEd/TU7n5uCXhBKdUgpiLhugkMAFErhKIWhKjS9Hii+B10nOOA81nezr5sBwgKUpvJyNRofL7yatexnZrTc9sKc1CEf9II+BIDU7HEj29bnIAucJELjFCYI7XEF12L8UAgeAkBoWWqJwRxeeCs0OROkQwSHq6W43dTffWcYAAFBK1LuvoFn8NAuNojWUfJC5gnb31s9eb9mZlMAMIAA4XFxgcaqPQPJ8FBwBbNuCI5vzWy+TANgZw4ppRPFJ2zBR6ja/uEZEpjtX80nDtN++/KpAAgIaFygmWnt91sCALSOZiu6zNNmA4bygNqppWKLkOVOTQvvxXgMhHf5EQuyUxnAzLBdOL1hwUXj0PbJaCSpATEFAAlV0HhXawzChhCQVEHDcJLntR7juq5PZo3SDQPAzOjRNTuz4rmRIO0GJtDKclFaIgRSYUQHOFLkGUOd6G4AGtnZD9bJeAxojPTYJaxG27weKXvgGz5Y7H1aHiDCa5eSreCY7Rsaj1GyQq0OgW3d80JuBtSEF8eF0RgcdPqq3D3wra77hwuAhvAYg8NQ1DDVGyG2NjTlZoIXAG0qBOedmp21qCOKQE0wn1Fwm4MZAGbWyuFHF34LDjNrgxrYYp4WMQFQKEHfqvA7ICogmMpzVgA06h+9FF4yjUJ4NI3MNAHQan+jZaiWjXufy8wQMsm8SNscn7MAkLefcL6Dj8N1gKB1rJrjc1UACto/+kCUFYxCt6jKghYAtzIMaRVYyRQxU5yPz1W710UA5IYH+l+vnhGUXmF6f1foGuHSpGanNQC0uF98Ue+BZ/9OU1wtUasBcOPicVvTYF6Q8sEJ/He80hBHDYC9adAQwk8T91uAFLJWNTGqAZDPAJjTy9YBD/28kLmqobsIgNL9PVr/fwZA1vPXGIBW1LuU0r0YIwqTB7njzxBWe4ewoHn+ZiZ4qAP+LO+98wB8B2Vh5F/TDn9TAAAAAElFTkSuQmCC');
  }

  .email {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAADtElEQVR4Xu1a7XnTQAzWTQBMQDsB2aCVFyBMQJmAMgHpBLQT0G5QFrDSCSgTECagTHA8bx7Zz/l8lw9/JXbufib2nfTqlU6SZejElzlx/SkBkBhw4ggkFzhxAqQgmFwguUAEARH5SERzIpoR0dlIgVoR0TMRPTLzQ0iHmguICJT9TkSXI1U6JvaSiD4w84v7QAUAVf4nEb2emPKFOlD+3AXBB0AmaHnflktm5uLHEgARuVLqly9Ya5+MMQtmBn1Gt0Tk0lq7MMZceMLDFR7xmwsAfnhfPAjlsyybRBzI83zpgfDAzDB4BYDfXrQHU0ZpeZ+qYAIRwb2LtWLmcx8A677IzJNKkkQkqJ/rAgmAxAAHgeQCKQakIOgGSBREX9VDvjAzioyjWyLiynnDzCiE1qvVLSAif736ANnhzTEhICIw0MKR6YWZ33QFQOWK1E2B7icX5UMAoknONy3bKyK4gbwtA26J6HNEQfwHulXKzL7BEBFUrLD6deSsO2Yu/2sFgPrQ3Fp7b4x5FTgQMQFsGCR1VqujZ1Fr1Fhr/xljropipxMXcDYB6rA4ukWhdU9ECJK9sEGtDrqvC5nAukMcCJ3fmgHuYVpmgg1vA0JAebBhXW52tUQE7TlYvdassdb+UatHGdgpAOoSEARRNxYbAACAaMUG7VLB6gAgtHAb3W47p3MAHLeYaWx4F2EDKAlq7r1EBOAC5JDVf6nVy7t+0wG9AeAAAUGLZMmXBdQEG3ZKoHZozOLWce/8reD2DoC6xZmywW9B4W+4Aqi6MYEKJDSlctqiQ4TfCUgvbg3XDxCRa+3Fha7MYAKlaSyCHNLZytKrDa6EG6jRGoQBHuKb2IBHQeEiNhS+HlLuB5KdJlY/GAO8g7clUHh854SmkfnbFkNND3UCJKI4kqSy67xlT1gdvt7qCj0KBnhCoE8fS6Bol4SmqTEGjwExQTWdDSVQ0TS2qdJHxwCfDU4lh+ux10LqaBjQhTWb7JEASB9G0peh4VLhJj7a9zspBmyLAXmer7wOz2Q/jyPhyrJsnX5HBySIqDJK0jdF+9xfRPzRn+CARG1EBiCgrM2y7KlPAfvaO8/zC4z4BOae0JxBbVIdlQ2MkvQl28H29Ud/amNy1trnSO//YEJ3dbA2Vs6iY3I4CP24DW2trmQZfB9tp803Dkp6xQpiApoZs0j/f3Al9j1Qy+tiVHbt8/6a1CDUvgDVgmCTDcb+TmLA2C3YVv7EgLYIjv39xICxW7Ct/IkBbREc+/v/AVOsXV8JPh/sAAAAAElFTkSuQmCC');
  }

  .hasaccount {
      position: absolute;
      bottom: 40rpx;
      left: 0;
      right: 0;
      margin: 0 auto;
      font-size: 30rpx;
      color: #999;
      text-align: center;
  }

  .hasaccount navigator {
      display: inline-block;
  }

  .hasaccount text {
      color: #333;
  }
  .button-sp-area button{
      margin-bottom: 50rpx;
  }
  .languages{
      text-align: center;
      font-size:30rpx;
  }
  .weui-cell_ft{
      position:absolute;
      right:20rpx;
      top:0;
      bottom:0;
      margin:0 auto;
      display:flex;
      align-items:center;
      text-align:right;
      justify-content:right;
      width:auto;
      z-index:888;
  }
  .sms{
      position: relative;
  }
  .rem1 {
      border: 0;
  }

</style>
<template>
  <view class='container'>
 <form bindsubmit="registerSubmit">
    <!-- <view class="logo">
      <image src="{{logo}}" />
      <text class="wave"></text>
    </view> -->
    <view class="weui-cell">
      <view class="weui-cell__hd">
        <label class="weui-label login" for="username"></label>
      </view>
      <input id="username" type="text" placeholder="用户名" name="username" value="{{form.username}}" class="weui-input" />
    </view>
    <view class="weui-cell">
      <view class="weui-cell__hd">
        <label class="weui-label mobile" for="mobile"></label>
      </view>
      <input id="mobile" type="text"  name="mobile" value="{{form.mobile}}" bindinput="bindMobileInput" placeholder="手机号" class="weui-input" />
      <text @tap="countrycode">+{{countryCode}}</text>
    </view>
    <view class="weui-cell sms">
      <view class="weui-cell__hd">
        <label class="weui-label yzm" for="code"></label>
      </view>
      <view class="weui-cell__bd">
        <input id="code" name="code" value="{{form.code}}" type="text" placeholder="验证码" class="weui-input" />
        <view class="weui-cell_ft">
          <button @tap="checkMobile('mobile')" size="mini" disabled="{{smsCodeDisabled}}" class="{{isactive?'isactive':'noactive'}}">
           获取验证码
          </button>
        </view>
      </view>
    </view>
    <view class="rem1">
      <checkbox-group bindchange="bindRemberInput">
        <label class="checkbox rem">
          <checkbox value="{{agree}}" checked="{{checked}}" style="zoom:70%;"/> 同意<text catchtap="agree" style="color:blue">{{oauth_register.protocol}}</text>
        </label>
      </checkbox-group>
    </view>
    <view class="button-sp-area">
      <button class="weui-btn weui-btn_primary" formType="submit">
        确认
      </button>
    </view>
    <view class="languages">
      <picker bindchange="bindSelectLanguage" value="{{langIndex}}" range="{{lang}}">
        <view>语言：{{lang[langIndex]}}</view>
      </picker>
    </view>
    <view class="hasaccount">
      已有用户名：
      <navigator redirect url="./bind">
        <text class="register">用户名</text>
      </navigator>
    </view>
  </form>
  <view class="country" wx:if="{{clickcountry}}">
    <view class="countrycode">
      <radio-group bindchange="choiceCountry">
        <view wx:for="{{countrycode}}" wx:key="{{item.value}}" wx:for-item="item">
          <text>{{item.name}} {{item.label}}</text>
          <!-- <text>{{item.label}}</text> -->
          <label class="radio">
            <radio value="{{item.value}}" />
            <!-- {{item.label}} -->
          </label>
        </view>
      </radio-group>
    </view>
  </view>
  </view>
</template>

<script>
  var countrycode=require("../api/country_code.js")
  var api=require("../api/api.js")
  import wepy from 'wepy'
  export default class Register extends wepy.page {
    config = {
      navigationBarTitleText: 'register'
    }
    data = {
      // logo: "../../images/logo.png",
      form: {
        username: "",
        mobile: "",
        code: "",
      },
      getSmsCode: "",
      getSmsCodeBtnColor: "#15b3e4",
      isactive: true,
      smsCodeDisabled: false,
      agree: '同意',
      isagree: "",
      checked: true,
      lang: ['中文简体', 'English'],
      langIndex: 0,
      langCode: ['zh', 'en'],
      showData: [],
      jsonData: [{ zh: "首页", en: "Home" }, { zh: "我的", en: "Me" }],
      clickcountry: false,
      countryCode: '86'
    }

    methods = {
      bindMobileInput: function (e) {
        this.form.mobile = e.detail.value
      },
      bindRemberInput (e) {
        this.form.agree = e.detail.value
      },
      choiceCountry (e) {
        this.form.countryCode = e.detail.value
        this.clickcountry = false
      },
      countrycode (e) {
        this.clickcountry = true
      }
    }

    validate (e) {
      var rule = {
        username: [{
          validate: e.detail.value.username === '',
          message: '请输入用户名'
        }],
        mobile: [{
          validate: e.detail.value.mobile === '',
          message: '请输入正确的11位手机号码'
        }],
        code: [{
          validate: e.detail.value.code === '',
          message: '请输入验证码'
        }]
      }
      for (var key in rule) {
        for (var i in rule[key]) {
          if (rule[key][i].validate) {
            wx.showToast({
              title: rule[key][i].message,
              icon: 'none',
              duration: 1000
            });
            return false
          }
        }
      }
      return true
    }

    registerSubmit (e) {
      if (this.validate(e)) {
        this.submit(e)
      }
    }

    submit(e){
      wepy.request({
          url: api.apiURL+'/api/account/username?username=',
          header: {
            "Content-Type": "application/json;charset=utf-8",
            "Cookie": ""
          },
          data: {
            username: e.detail.value.username
          },
        })
        .then(res => {
          if (res.data === true) {
            wx.showToast({
              title: '用户名已存在',
              icon: 'none',
              duration: 1000
            });
          } else {
            wepy.request({
              url: api.apiURL+'/api/oauth/register',
              header: {
                "Content-Type": "application/json;charset=utf-8",
                "Cookie": ""
              },
              method: "POST",
              data: {
                Username: e.detail.value.username,
                CountryCode: this.countryCode, // todo 目前只支持86
                Mobile: e.detail.value.mobile,
                Code: e.detail.value.code,
                Agree: true
              },
            })
              .then(res => {
                let Sid=''
                if (res.data.code === 0) {
                  Sid=res.data.data
                  // app.setSid(res.data.data)
                  wx.showToast({
                    title: '登录成功',
                    icon: 'none',
                    duration: 1000
                  });
                  setTimeout(function () {
                    // this.$navigate('/pages/register')
                    this.$navigate('/pages/index');
                    // wx.switchTab({
                    //   url: "../index/index"
                    // });
                  }, 2000);
                } else {
                  wx.showToast({
                    title: '失败',
                    icon: 'none',
                    duration: 1000
                  });
                }
              })
          }
        })
        .catch(res => {
          wx.showToast({
            title: '网络错误',
            icon: 'none',
            duration: 1000
          });
        })
      }
      checkMobile (e) {
        if(this.form.mobile===''){
          wx.showToast({
            title: '请输入正确的11位手机号码',
            icon: 'none',
            duration: 1000
          });
          return;
        }
        wepy.request({
          url: api.apiURL+'/api/account/mobile',
          header: {
            "Content-Type": "application/json;charset=utf-8",
            "Cookie": ""
          },
          data: {
            countryCode: this.countryCode,
            mobile: this.form.mobile,
          },
        })
        .then(res => {
          console.log(res,'res')
          if (res.data === true) {
            wx.showToast({
              title: '用户名已存在',
              icon: 'none',
              duration: 1000
            });
            return;
          } else {
            wepy.request({
              url: api.apiURL+'/api/account/smsverificationcode',
              method: "POST",
              header: {
                "Content-Type": "application/json;charset=utf-8",
                "Cookie": ""
              },
              data: {
                countryCode: this.countryCode,
                mobile: this.form.mobile
              },
            })
              .then(res => {
                if (res.data.code === 0) {
                  wx.showToast({
                    title: '发送验证码',
                    icon: 'none',
                    duration: 1000
                  })
                  var count = 60;
                  var si = setInterval(function () {
                    if (count > 0) {
                      count--;
                      this.getSmsCode=count + " s"
                      this.getSmsCodeBtnColor= "#dedede"
                      this.isactive=false
                      this.smsCodeDisabled=true
                    } else {
                      this.getSmsCode='验证码'
                      this.getSmsCodeBtnColor= "#15b3e4"
                      this.isactive=true
                      this.smsCodeDisabled=false
                      count = 60;
                      clearInterval(si);
                    }
                  }, 1000);
                } else {
                  wx.showToast({
                    title: '手机号错误',
                    icon: 'none',
                    duration: 1000
                  })
                }
              })
          }
        })
        .catch(res => {
          wx.showToast({
            title: '网络错误',
            icon: 'none',
            duration: 1000
          });
        })
      }

    async onLoad() {
      this.countrycode=countrycode
    }
  }
</script>
